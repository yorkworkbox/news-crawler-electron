<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>新聞連結搜尋爬蟲</title>
    <style>
        :root {
            --bg-primary: #1a1a1a; --bg-secondary: #2d2d2d; --bg-tertiary: #3d3d3d;
            --text-primary: #ffffff; --text-secondary: #b0b0b0; --text-muted: #888888;
            --border-color: #404040; --accent-color: #4a9eff; --accent-hover: #3a8eef;
            --success-color: #10b981; --error-color: #ef4444; --warning-color: #f59e0b;
        }
        .light-mode {
            --bg-primary: #ffffff; --bg-secondary: #f8f9fa; --bg-tertiary: #e9ecef;
            --text-primary: #212529; --text-secondary: #495057; --text-muted: #6c757d;
            --border-color: #dee2e6; --accent-color: #0d6efd; --accent-hover: #0b5ed7;
            --success-color: #198754; --error-color: #dc3545; --warning-color: #fd7e14;
        }
        html { overflow-y: scroll; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background-color: var(--bg-primary); color: var(--text-primary); line-height: 1.6; transition: background-color 0.3s ease, color 0.3s ease; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; min-height: 100vh; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 2px solid var(--border-color); }
        .title { display: flex; align-items: center; gap: 12px; }
        .title h1 { font-size: 28px; font-weight: 700; }
        .title .icon { width: 32px; height: 32px; color: var(--accent-color); }
        .theme-toggle { background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 8px; padding: 8px 16px; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; gap: 8px; color: var(--text-primary); }
        .theme-toggle:hover { background: var(--bg-tertiary); }
        .form-section { background: var(--bg-secondary); border-radius: 12px; padding: 24px; margin-bottom: 20px; border: 1px solid var(--border-color); }
        .form-group { margin-bottom: 20px; }
        .form-group-header, .panel-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .form-group-header label, .panel-header h3 { margin-bottom: 0; font-weight: 600; font-size: 1em; }
        .form-group input[type="text"] { width: 100%; padding: 12px 16px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--bg-primary); color: var(--text-primary); font-size: 14px; transition: all 0.3s ease; }
        .form-group input[type="text"]:focus { outline: none; border-color: var(--accent-color); box-shadow: 0 0 0 3px rgba(74, 158, 255, 0.1); }
        .tab-container { border: 1px solid var(--border-color); border-radius: 8px; overflow: hidden; transition: border-color 0.3s ease; }
        .tab-buttons { display: flex; background-color: var(--bg-secondary); }
        .tab-btn { flex: 1; padding: 10px 15px; background-color: transparent; border: none; border-bottom: 2px solid transparent; color: var(--text-secondary); cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.3s ease; }
        .tab-btn:hover { background-color: var(--bg-tertiary); }
        .tab-btn.active { color: var(--accent-color); border-bottom-color: var(--accent-color); }
        .tab-content { background-color: var(--bg-primary); padding: 8px; max-height: 250px; overflow-y: auto; }
        .tab-panel { display: none; }
        .tab-panel.active { display: block; }
        .website-item { display: flex; align-items: center; padding: 8px; border-radius: 6px; transition: background-color 0.2s ease; }
        .website-item:hover { background-color: var(--bg-tertiary); }
        .website-item input[type="checkbox"] { width: 16px; height: 16px; margin-right: 12px; cursor: pointer; }
        .website-item label { margin-bottom: 0; font-weight: 500; cursor: pointer; flex-grow: 1; }
        .websites-header { padding: 4px 8px; margin-bottom: 8px; border-bottom: 1px solid var(--border-color); }
        .button-group { display: flex; flex-wrap: wrap; gap: 12px; margin-top: 20px; }
        .btn { padding: 10px 20px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 14px; }
        .btn-primary { background: var(--accent-color); color: white; }
        .btn-primary:hover:not(:disabled) { background: var(--accent-hover); }
        .btn:disabled { background: var(--text-muted); cursor: not-allowed; }
        .btn-secondary { background: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border-color); }
        .btn-secondary:hover { background: var(--border-color); }
        .btn-danger { background-color: var(--error-color); color: white; }
        .btn-danger:hover:not(:disabled) { opacity: 0.9; }
        .btn-small { padding: 4px 10px; font-size: 12px; }
        .btn-delete-row { background-color: var(--error-color); color: white; padding: 6px 12px; font-size: 12px; }
        .website-edit-item { display: flex; gap: 10px; align-items: center; padding: 8px; }
        .website-edit-item input { flex-grow: 1; padding: 8px 12px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--bg-primary); color: var(--text-primary); font-size: 14px; transition: all 0.3s ease; }
        .website-edit-item input:focus { outline: none; border-color: var(--accent-color); box-shadow: 0 0 0 3px rgba(74, 158, 255, 0.1); }
        .website-edit-item input.name-input { flex-basis: 30%; }
        .website-edit-item input.url-input { flex-basis: 60%; }
        .add-row-container { display: flex; justify-content: center; padding: 10px 8px 0 8px; }
        .btn-add-row { background-color: var(--success-color); color: white; width: 100%; padding: 8px; font-weight: 600; font-size: 14px; border: none; border-radius: 8px; cursor: pointer; }
        .debug-mode-toggle { display: flex; align-items: center; gap: 8px; margin-top: 20px; color: var(--text-secondary); font-size: 13px; }
        .debug-mode-toggle label { margin-bottom: 0; cursor: pointer; }
        .debug-mode-toggle input { width: auto; }
        .error-message { color: var(--error-color); font-size: 12px; margin-top: 6px; display: none; }
        .error-message.show { display: block; }
        .input-error { border-color: var(--error-color) !important; box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.2) !important; }
        .results-section { background: var(--bg-secondary); border-radius: 12px; padding: 24px; border: 1px solid var(--border-color); margin-top: 20px; }
        .results-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .results-title { font-size: 20px; font-weight: 600; display: flex; align-items: center; gap: 8px; }
        .result-item { background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 8px; padding: 16px; margin-bottom: 12px; transition: all 0.3s ease; }
        .result-item:hover { border-color: var(--accent-color); }
        .result-website-header { position: relative; display: flex; justify-content: space-between; align-items: center; }
        .result-website-header .actions { display: flex; gap: 8px; align-items: center; }
        .result-link-item { position: relative; margin: 12px 0; padding: 12px; background: var(--bg-tertiary); border-radius: 6px; }
        .btn-delete { width: 24px; height: 24px; padding: 0; display: flex; align-items: center; justify-content: center; background-color: var(--error-color); color: white; border: none; border-radius: 50%; font-size: 16px; line-height: 1; cursor: pointer; opacity: 0.7; transition: opacity 0.2s ease; z-index: 2; }
        .result-link-item .btn-delete { position: absolute; top: 8px; right: 8px; }
        .btn-delete:hover { opacity: 1; }
        .manual-link-item a { color: var(--accent-color); text-decoration: none; display: block; padding: 8px; border-radius: 6px; transition: background-color 0.2s ease; }
        .manual-link-item a:hover { background-color: var(--bg-tertiary); text-decoration: underline; }
        .info-panel { background: rgba(74, 158, 255, 0.05); border: 1px solid var(--accent-color); border-radius: 8px; padding: 16px; margin-top: 20px; }
        .info-panel h3 { color: var(--accent-color); margin-bottom: 8px; }
        .info-panel ul { color: var(--text-secondary); font-size: 13px; padding-left: 20px; }
        .info-panel li { margin-bottom: 4px; }
        .loading-spinner { display: inline-block; width: 16px; height: 16px; border: 2px solid transparent; border-top: 2px solid currentColor; border-radius: 50%; animation: spin 1s linear infinite; }
        .hidden { display: none !important; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background-color: var(--bg-secondary); padding: 24px; border-radius: 12px; border: 1px solid var(--border-color); box-shadow: 0 10px 25px rgba(0,0,0,0.3); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; }
        .modal-header h3 { font-size: 18px; }
        .modal-close { background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-primary); }
        .modal-body { flex-grow: 1; overflow: hidden; }
        #htmlModal .modal-content { width: 80%; height: 80%; display: flex; flex-direction: column; }
        #modalContent { width: 100%; height: 100%; resize: none; font-family: monospace; font-size: 12px; background-color: var(--bg-primary); color: var(--text-secondary); border: 1px solid var(--border-color); border-radius: 8px; padding: 10px; }
        #confirmModal .modal-content { max-width: 400px; }
        #confirmMessage { margin-bottom: 24px; color: var(--text-secondary); line-height: 1.7; }
        #confirmButtons { display: flex; justify-content: flex-end; gap: 12px; }
        #confirmButtons .btn { flex: 1; }
        .progress-bar { width: 100%; height: 4px; background: var(--bg-tertiary); border-radius: 2px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--accent-color); transition: width 0.3s ease; }

        /* --- 新增：頂部通知樣式 --- */
        #notificationContainer {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 2000;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            pointer-events: none; /* 允許點擊穿透容器 */
        }
        .notification-item {
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
            font-weight: 500;
            pointer-events: auto; /* 通知本身可以點擊 */
            animation: slideIn 0.3s ease-out forwards, slideOut 0.3s ease-in forwards 2.7s;
        }
        .notification-item.status-success { background-color: var(--success-color); color: white; }
        .notification-item.status-error { background-color: var(--error-color); color: white; }
        .notification-item.status-info { background-color: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border-color); }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes slideOut {
            from { opacity: 1; transform: translateY(0); }
            to { opacity: 0; transform: translateY(-20px); }
        }
    </style>
</head>
<body>
    <!-- 新增：頂部通知容器 -->
    <div id="notificationContainer"></div>

    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="title"><svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9v-9m0-9v9"></path></svg><h1>新聞連結搜尋爬蟲</h1></div>
            <button class="theme-toggle" onclick="toggleTheme()"><svg width="16" height="16" fill="currentColor" id="theme-icon-svg"><path id="theme-icon" d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z M8 4a4 4 0 0 0-4 4 .5.5 0 0 1-1 0 5 5 0 0 1 5-5 .5.5 0 0 1 0 1z"/></svg> <span id="theme-text">淺色模式</span></button>
        </div>

        <!-- Form Section -->
        <div class="form-section">
            <div class="form-group">
                <label for="keyword">關鍵字或新聞標題</label>
                <input type="text" id="keyword" placeholder="請輸入要搜尋的關鍵字或完整新聞標題">
                <div id="keywordError" class="error-message"></div>
            </div>
            
            <div class="form-group">
                <div class="form-group-header">
                    <label>網站清單</label>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <button class="btn btn-secondary btn-small hidden" id="addNewRowBtnTop" onclick="addNewRowToActiveTab()">新增</button>
                        <button class="btn btn-primary btn-small hidden" id="saveBtn" onclick="saveTemporaryChanges()">儲存</button>
                        <button class="btn btn-secondary btn-small hidden" id="cancelBtn" onclick="exitEditMode(false)">取消</button>
                        <button class="btn btn-secondary btn-small" id="editBtn" onclick="enterEditMode()">編輯</button>
                    </div>
                </div>
                
                <div id="tabContainer" class="tab-container">
                    <div class="tab-buttons">
                        <button id="crawlTabBtn" class="tab-btn active" onclick="switchTab('crawl')">可爬取清單</button>
                        <button id="manualTabBtn" class="tab-btn" onclick="switchTab('manual')">手動清單</button>
                    </div>
                    <div class="tab-content">
                        <!-- 可爬取清單面板 -->
                        <div id="crawlTabPanel" class="tab-panel active">
                            <div id="viewModeContainer">
                                <div class="websites-header website-item">
                                    <input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll(this.checked)"><label for="selectAllCheckbox">全選</label>
                                </div>
                                <div id="websitesContainer"></div>
                            </div>
                            <div id="editModeContainer" class="hidden">
                                <div id="websitesEditContainer"></div>
                                <div class="add-row-container">
                                    <button class="btn btn-add-row" onclick="addNewRow()">新增</button>
                                </div>
                            </div>
                        </div>
                        <!-- 手動清單面板 -->
                        <div id="manualTabPanel" class="tab-panel">
                            <div id="manualLinksContainer">
                                <div id="manualLinksList"></div>
                            </div>
                            <div id="manualEditContainer" class="hidden">
                                <div id="manualWebsitesEditContainer"></div>
                                <div class="add-row-container">
                                    <button class="btn btn-add-row" onclick="addNewManualRow()">新增</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="websiteError" class="error-message"></div>
            </div>

            <div class="button-group">
                <button class="btn btn-primary" id="searchBtn" onclick="startSearch()"><svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z"/></svg> <span>開始搜尋</span></button>
                <button class="btn btn-primary hidden" id="openAllBtnMain" onclick="openAllManualLinks()"><svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M8.636 3.5a.5.5 0 0 0-.5-.5H1.5A1.5 1.5 0 0 0 0 4.5v10A1.5 1.5 0 0 0 1.5 16h10a1.5 1.5 0 0 0 1.5-1.5V7.864a.5.5 0 0 0-1 0V14.5a.5.5 0 0 1-.5.5h-10a.5.5 0 0 1-.5-.5v-10a.5.5 0 0 1 .5-.5h6.636a.5.5 0 0 0 .5-.5z"/><path d="M16 .5a.5.5 0 0 0-.5-.5h-5a.5.5 0 0 0 0 1h3.793L6.146 9.146a.5.5 0 1 0 .708.708L15 1.707V5.5a.5.5 0 0 0 1 0v-5z"/></svg> <span>全部開啟</span></button>
                <button class="btn btn-secondary" onclick="loadAllLists()">重設為預設</button>
                <button class="btn btn-secondary" id="clearResultsBtn" onclick="clearResults()">清除結果</button>
                <button class="btn btn-primary hidden" id="saveAsDefaultBtn" onclick="saveToDefaultFile()">儲存成預設清單</button>
            </div>

            <div class="debug-mode-toggle"><input type="checkbox" id="debugModeCheckbox"><label for="debugModeCheckbox">啟用除錯模式</label></div>
            <div id="progressContainer" class="hidden" style="margin-top: 20px;">
                <div id="progressText" style="text-align: center; color: var(--text-secondary); font-size: 14px; margin-bottom: 8px;"></div>
                <div class="progress-bar"><div id="progressFill" class="progress-fill"></div></div>
            </div>
        </div>
        
        <div id="resultsSection" class="results-section hidden">
            <div class="results-header">
                <div class="results-title"><svg width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M10.97 4.97a.235.235 0 0 0-.02.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.061L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-1.071-1.05z"/></svg> <span>搜尋結果 -</span> <span id="resultCount"></span></div>
                <button class="btn btn-secondary btn-small" onclick="copyAllResults()">複製所有連結</button>
            </div>
            <div id="resultsContainer"></div>
        </div>

        <div class="info-panel">
            <h3>使用說明</h3>
            <ul>
                <li>在關鍵字欄位輸入要搜尋的關鍵字或完整新聞標題。</li>
                <li>點擊「編輯」可同時修改兩個清單，修改後需點擊「儲存成預設清單」才會永久保存。</li>
                <li>點擊分頁標籤可在「可爬取清單」與「手動清單」之間切換。</li>
            </ul>
        </div>

        <!-- Modals -->
        <div id="htmlModal" class="modal-overlay hidden">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 id="modalTitle"></h3>
                    <button class="modal-close" onclick="closeModal('htmlModal')">×</button>
                </div>
                <div class="modal-body"><textarea id="modalContent" readonly></textarea></div>
            </div>
        </div>
        
        <div id="confirmModal" class="modal-overlay hidden">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 id="confirmTitle"></h3>
                </div>
                <div class="modal-body">
                    <p id="confirmMessage"></p>
                </div>
                <div id="confirmButtons">
                    <button class="btn btn-primary" id="confirmOkBtn">確認</button>
                    <button class="btn btn-secondary" id="confirmCancelBtn">取消</button>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // --- (所有 JS 程式碼都與上一版完全相同，此處為求完整性而全部貼上) ---

        let isSearching = false;
        let searchResults = [];
        let rawHtmlCache = {};
        let currentWebsiteState = [];
        let manualSearchState = [];
        let searchResultIdCounter = 0;
        let stopSearchRequested = false;
        let searchBtnWidth = 0;

        window.addEventListener('DOMContentLoaded', () => {
            if (localStorage.getItem('theme') === 'light') {
                document.body.classList.add('light-mode');
            }
            updateThemeIcon();
            loadAllLists().catch(console.error);
            
            document.getElementById('keyword').addEventListener('focus', () => clearInputError('keyword'));
            document.getElementById('tabContainer').addEventListener('change', () => clearInputError('website'));
        });

        function switchTab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-panel').forEach(panel => panel.classList.remove('active'));
            document.getElementById(tabName + 'TabBtn').classList.add('active');
            document.getElementById(tabName + 'TabPanel').classList.add('active');

            const searchBtn = document.getElementById('searchBtn');
            const openAllBtnMain = document.getElementById('openAllBtnMain');
            const clearResultsBtn = document.getElementById('clearResultsBtn');
            
            if (tabName === 'crawl') {
                searchBtn.classList.remove('hidden');
                clearResultsBtn.classList.remove('hidden');
                openAllBtnMain.classList.add('hidden');
            } else {
                searchBtn.classList.add('hidden');
                clearResultsBtn.classList.add('hidden');
                openAllBtnMain.classList.remove('hidden');
            }
        }
        
        async function loadAllLists() {
            try {
                const [crawlResult, manualResult] = await Promise.all([
                    window.electronAPI.getDefaultWebsitesContent(),
                    window.electronAPI.getManualSitesContent()
                ]);

                if (crawlResult.status === 'success') {
                    currentWebsiteState = parseWebsitesFromText(crawlResult.content);
                    renderCheckboxes();
                } else { throw new Error('無法載入可爬取網站清單'); }

                if (manualResult.status === 'success') {
                    manualSearchState = parseWebsitesFromText(manualResult.content, false);
                    renderManualSearchList();
                } else { throw new Error('無法載入手動搜尋清單'); }
                
                showStatus('所有網站清單已成功載入', 'success');

            } catch (error) {
                console.error('載入清單時發生錯誤:', error);
                showStatus(`載入清單失敗: ${error.message}`, 'error');
            }
        }

        function enterEditMode() {
            document.getElementById('viewModeContainer').classList.add('hidden');
            document.getElementById('editModeContainer').classList.remove('hidden');
            renderEditor();
            
            document.getElementById('manualLinksContainer').classList.add('hidden');
            document.getElementById('manualEditContainer').classList.remove('hidden');
            renderManualEditor();
            
            document.getElementById('editBtn').classList.add('hidden');
            document.getElementById('addNewRowBtnTop').classList.remove('hidden');
            document.getElementById('saveBtn').classList.remove('hidden');
            document.getElementById('cancelBtn').classList.remove('hidden');
            document.getElementById('saveAsDefaultBtn').classList.remove('hidden');
        }

        function exitEditMode(wasSaved = false) {
            renderCheckboxes();
            renderManualSearchList();
            document.getElementById('viewModeContainer').classList.remove('hidden');
            document.getElementById('editModeContainer').classList.add('hidden');
            
            document.getElementById('manualLinksContainer').classList.remove('hidden');
            document.getElementById('manualEditContainer').classList.add('hidden');

            document.getElementById('editBtn').classList.remove('hidden');
            document.getElementById('addNewRowBtnTop').classList.add('hidden');
            document.getElementById('saveBtn').classList.add('hidden');
            document.getElementById('cancelBtn').classList.add('hidden');
            document.getElementById('saveAsDefaultBtn').classList.add('hidden');
        }
        
        function getWebsiteStateFromEditor(containerId, originalState) {
            const newState = [];
            const editRows = document.querySelectorAll(`#${containerId} .website-edit-item`);
            editRows.forEach((row) => {
                const nameInput = row.querySelector('.name-input');
                const urlInput = row.querySelector('.url-input');
                if (nameInput.value.trim() && urlInput.value.trim()) {
                    const originalUrl = urlInput.dataset.originalUrl;
                    const originalEntry = originalState.find(s => s.url === originalUrl);
                    newState.push({
                        name: nameInput.value.trim(),
                        url: urlInput.value.trim(),
                        checked: originalEntry ? originalEntry.checked : true
                    });
                }
            });
            return newState;
        }

        function saveTemporaryChanges() {
            currentWebsiteState = getWebsiteStateFromEditor('websitesEditContainer', currentWebsiteState);
            manualSearchState = getWebsiteStateFromEditor('manualWebsitesEditContainer', manualSearchState);
            showStatus('變更已暫時套用', 'success');
            exitEditMode(true);
        }

        async function saveToDefaultFile() {
            const finalCrawlState = getWebsiteStateFromEditor('websitesEditContainer', currentWebsiteState);
            const finalManualState = getWebsiteStateFromEditor('manualWebsitesEditContainer', manualSearchState);

            const crawlContent = finalCrawlState.map(item => `${item.name}：${item.url}`).join('\n');
            const manualContent = finalManualState.map(item => `${item.name}：${item.url}`).join('\n');

            try {
                const [crawlSaveResult, manualSaveResult] = await Promise.all([
                    window.electronAPI.saveDefaultWebsitesContent(crawlContent),
                    window.electronAPI.saveManualSitesContent(manualContent)
                ]);

                if (crawlSaveResult.status !== 'success' || manualSaveResult.status !== 'success') {
                    throw new Error('儲存一個或多個檔案失敗');
                }
                
                currentWebsiteState = finalCrawlState.map(item => ({ ...item, checked: true }));
                manualSearchState = finalManualState;
                showStatus('已成功將兩個清單儲存成預設值！', 'success');
                exitEditMode(true);

            } catch (error) {
                console.error('儲存預設清單失敗:', error);
                showStatus(`儲存失敗: ${error.message}`, 'error');
            }
        }

        function renderCheckboxes() {
            const container = document.getElementById('websitesContainer');
            let allItemsHtml = '';
            currentWebsiteState.forEach((website, index) => {
                allItemsHtml += `<div class="website-item"><input type="checkbox" id="website-${index}" onchange="updateCheckedState(${index}, this.checked)" ${website.checked ? 'checked' : ''}><label for="website-${index}">${website.name}</label></div>`;
            });
            container.innerHTML = allItemsHtml;
            syncSelectAllCheckbox();
        }

        function renderEditor() {
            const container = document.getElementById('websitesEditContainer');
            let allItemsHtml = '';
            currentWebsiteState.forEach(website => {
                allItemsHtml += `<div class="website-edit-item"><input type="text" class="name-input" value="${website.name}" placeholder="媒體名稱"><input type="text" class="url-input" value="${website.url}" data-original-url="${website.url}" placeholder="https://example.com"><button class="btn btn-delete-row" onclick="deleteEditRow(this)">刪除</button></div>`;
            });
            container.innerHTML = allItemsHtml;
        }

        function renderManualSearchList() {
            const container = document.getElementById('manualLinksList');
            if (manualSearchState.length === 0) {
                 container.innerHTML = '<p style="color: var(--text-muted); padding: 8px;">沒有手動搜尋網站。</p>';
                 return;
            }
            let allItemsHtml = '';
            manualSearchState.forEach(site => {
                allItemsHtml += `<div class="manual-link-item"><a href="#" onclick="event.preventDefault(); window.electronAPI.openExternalLink('${site.url}');">${site.name}</a></div>`;
            });
            container.innerHTML = allItemsHtml;
        }

        function renderManualEditor() {
            const container = document.getElementById('manualWebsitesEditContainer');
            let allItemsHtml = '';
            manualSearchState.forEach(website => {
                allItemsHtml += `<div class="website-edit-item"><input type="text" class="name-input" value="${website.name}" placeholder="媒體名稱"><input type="text" class="url-input" value="${website.url}" data-original-url="${website.url}" placeholder="https://example.com"><button class="btn btn-delete-row" onclick="deleteEditRow(this)">刪除</button></div>`;
            });
            container.innerHTML = allItemsHtml;
        }
        
        function addNewRowToActiveTab() {
            if (document.getElementById('crawlTabPanel').classList.contains('active')) {
                addNewRow();
            } else {
                addNewManualRow();
            }
        }

        function addNewRow() {
            const container = document.getElementById('websitesEditContainer');
            const itemHtml = `<div class="website-edit-item"><input type="text" class="name-input" placeholder="媒體名稱"><input type="text" class="url-input" placeholder="https://example.com" data-original-url=""><button class="btn btn-delete-row" onclick="deleteEditRow(this)">刪除</button></div>`;
            container.insertAdjacentHTML('beforeend', itemHtml);
            container.closest('.tab-content').scrollTop = container.closest('.tab-content').scrollHeight;
        }
        
        function addNewManualRow() {
            const container = document.getElementById('manualWebsitesEditContainer');
            const itemHtml = `<div class="website-edit-item"><input type="text" class="name-input" placeholder="媒體名稱"><input type="text" class="url-input" placeholder="https://example.com" data-original-url=""><button class="btn btn-delete-row" onclick="deleteEditRow(this)">刪除</button></div>`;
            container.insertAdjacentHTML('beforeend', itemHtml);
            container.closest('.tab-content').scrollTop = container.closest('.tab-content').scrollHeight;
        }

        function deleteEditRow(button) {
            button.closest('.website-edit-item').remove();
        }

        async function openAllManualLinks() {
            if (manualSearchState.length === 0) return;
            const confirmed = await showConfirmation('確認操作', `即將在預設瀏覽器中開啟 ${manualSearchState.length} 個分頁，確定嗎？`);
            if (confirmed) {
                manualSearchState.forEach(site => {
                    window.electronAPI.openExternalLink(site.url);
                });
            }
        }

        function parseWebsitesFromText(websitesText, defaultChecked = true) {
            const websites = [];
            const lines = websitesText.trim().split('\n');
            for (const line of lines) {
                const trimmedLine = line.trim();
                if (!trimmedLine) continue;
                const colonIndex = trimmedLine.indexOf('：');
                if (colonIndex > 0) {
                    websites.push({ name: trimmedLine.substring(0, colonIndex).trim(), url: trimmedLine.substring(colonIndex + 1).trim(), checked: defaultChecked });
                } else if (trimmedLine.startsWith('http')) {
                    try {
                        const url = new URL(trimmedLine);
                        websites.push({ name: url.hostname, url: trimmedLine, checked: defaultChecked });
                    } catch(e) { console.error("無效的 URL:", trimmedLine); }
                }
            }
            return websites;
        }

        function updateCheckedState(index, isChecked) {
            if (currentWebsiteState[index]) currentWebsiteState[index].checked = isChecked;
            syncSelectAllCheckbox();
        }

        function toggleSelectAll(isChecked) {
            currentWebsiteState.forEach(website => website.checked = isChecked);
            renderCheckboxes();
        }

        function syncSelectAllCheckbox() {
            const allChecked = currentWebsiteState.length > 0 && currentWebsiteState.every(website => website.checked);
            document.getElementById('selectAllCheckbox').checked = allChecked;
        }

        // --- 修改：showStatus 函式重構為頂部通知 ---
        function showStatus(message, type = 'info', duration = 3000) {
            const container = document.getElementById('notificationContainer');
            const notification = document.createElement('div');
            notification.className = `notification-item status-${type}`;
            notification.innerHTML = `<svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zm.93-9.412-1 4.705c-.07.34.029.533.304.533.194 0 .487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703 0-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381 2.29-.287zM8 5.5a1 1 0 1 1 0-2 1 1 0 0 1 0 2z"/></svg> <span>${message}</span>`;
            
            container.appendChild(notification);

            if (duration !== null) {
                setTimeout(() => {
                    notification.style.animation = 'slideOut 0.3s ease-in forwards';
                    notification.addEventListener('animationend', () => {
                        notification.remove();
                    });
                }, duration);
            }
        }
        
        function requestStopSearch() {
            const searchBtn = document.getElementById('searchBtn');
            stopSearchRequested = true;
            searchBtn.disabled = true;
            searchBtn.innerHTML = `<span>停止中...</span>`;
        }
        
        function clearInputError(type) {
            if (type === 'keyword') {
                document.getElementById('keyword').classList.remove('input-error');
                document.getElementById('keywordError').classList.remove('show');
            } else if (type === 'website') {
                document.getElementById('tabContainer').classList.remove('input-error');
                document.getElementById('websiteError').classList.remove('show');
            }
        }

        async function startSearch() {
            if (isSearching) return;
            clearInputError('keyword');
            clearInputError('website');

            const keyword = document.getElementById('keyword').value.trim();
            if (!keyword) {
                document.getElementById('keyword').classList.add('input-error');
                const errorEl = document.getElementById('keywordError');
                errorEl.textContent = '請輸入關鍵字';
                errorEl.classList.add('show');
                return;
            }
            const websitesToSearch = currentWebsiteState.filter(w => w.checked);
            if (websitesToSearch.length === 0) {
                document.getElementById('tabContainer').classList.add('input-error');
                const errorEl = document.getElementById('websiteError');
                errorEl.textContent = '請至少選擇一個網站進行搜尋';
                errorEl.classList.add('show');
                return;
            }

            isSearching = true;
            stopSearchRequested = false;
            const searchBtn = document.getElementById('searchBtn');
            
            if (searchBtnWidth === 0) searchBtnWidth = searchBtn.offsetWidth;
            searchBtn.style.minWidth = `${searchBtnWidth}px`;
            
            searchBtn.classList.remove('btn-primary');
            searchBtn.classList.add('btn-danger');
            searchBtn.onclick = requestStopSearch;
            searchBtn.innerHTML = `<svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M5 3.5h6A1.5 1.5 0 0 1 12.5 5v6a1.5 1.5 0 0 1-1.5 1.5H5A1.5 1.5 0 0 1 3.5 11V5A1.5 1.5 0 0 1 5 3.5z"/></svg> <span>停止搜尋</span>`;

            clearResults(true);
            document.getElementById('resultCount').textContent = '搜尋中...';
            
            try {
                updateProgress(0, websitesToSearch.length, '準備搜尋');
                for (let i = 0; i < websitesToSearch.length; i++) {
                    if (stopSearchRequested) break; 
                    updateProgress(i + 1, websitesToSearch.length, `正在搜尋 ${websitesToSearch[i].name}`);
                    const results = await searchWebsite(websitesToSearch[i], keyword);
                    if (results) searchResults.push(...results);
                    displayResults();
                    if (i < websitesToSearch.length - 1) await new Promise(resolve => setTimeout(resolve, 1000 + Math.random() * 2000));
                }
            } catch (error) {
                console.error("搜尋過程中發生錯誤:", error);
                document.getElementById('resultCount').textContent = `搜尋失敗: ${error.message}`;
            } finally {
                isSearching = false;
                
                const successCount = searchResults.filter(r => r.status === 'success').length;
                const searchedCount = new Set(searchResults.map(r => r.website)).size;
                const resultCountEl = document.getElementById('resultCount');

                if (stopSearchRequested) {
                    resultCountEl.textContent = `中斷 (找到 ${successCount} 筆，搜尋了 ${searchedCount} 個網站)`;
                } else {
                    resultCountEl.textContent = `完成 (找到 ${successCount} 筆，搜尋了 ${searchedCount} 個網站)`;
                }
                
                searchBtn.disabled = false;
                searchBtn.classList.remove('btn-danger');
                searchBtn.classList.add('btn-primary');
                searchBtn.onclick = startSearch;
                searchBtn.innerHTML = `<svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z"/></svg> <span>開始搜尋</span>`;
                searchBtn.style.minWidth = '';
                
                updateProgress(0, 0, '');
                stopSearchRequested = false;
            }
        }
        
        function toggleTheme() {
            document.body.classList.toggle('light-mode');
            const isLight = document.body.classList.contains('light-mode');
            updateThemeIcon(isLight);
            localStorage.setItem('theme', isLight ? 'light' : 'dark');
        }

        function updateThemeIcon(isLight) {
            const themeIcon = document.getElementById('theme-icon');
            const themeText = document.getElementById('theme-text');
            if (isLight === undefined) {
                 isLight = document.body.classList.contains('light-mode');
            }
            if (isLight) {
                themeIcon.setAttribute('d', 'M6 .278a.768.768 0 0 1 .08.858 7.208 7.208 0 0 0-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527 0 1.04-.055 1.533-.16a.787.787 0 0 1 .81.316.733.733 0 0 1-.031.893A8.349 8.349 0 0 1 8.344 16C3.734 16 0 12.286 0 7.71 0 4.266 2.114 1.312 5.124.06A.752.752 0 0 1 6 .278z');
                themeText.textContent = '深色模式';
            } else {
                themeIcon.setAttribute('d', 'M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z M8 4a4 4 0 0 0-4 4 .5.5 0 0 1-1 0 5 5 0 0 1 5-5 .5.5 0 0 1 0 1z');
                themeText.textContent = '淺色模式';
            }
        }
        
        async function clearResults(isFromSearch = false) {
            if (!isFromSearch && searchResults.length > 0) {
                const confirmed = await showConfirmation('確認清除', '確定要清除所有搜尋結果嗎？此操作無法復原。');
                if (!confirmed) return;
            }
            document.getElementById('resultsSection').classList.add('hidden');
            document.getElementById('resultsContainer').innerHTML = '';
            searchResults = [];
            searchResultIdCounter = 0;
            rawHtmlCache = {};
        }

        function updateProgress(current, total, text) {
            const progressContainer = document.getElementById('progressContainer');
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            if (total > 0) {
                const percentage = (current / total) * 100;
                progressFill.style.width = `${percentage}%`;
                progressText.textContent = `${text} (${current}/${total})`;
                progressContainer.classList.remove('hidden');
            } else {
                progressContainer.classList.add('hidden');
            }
        }
        
        function deleteResult(resultId) {
            const indexToDelete = searchResults.findIndex(r => r.id === resultId);
            if (indexToDelete > -1) {
                searchResults.splice(indexToDelete, 1);
            }
            displayResults();
        }
        
        function deleteWebsiteResult(websiteName) {
            searchResults = searchResults.filter(r => r.website !== websiteName);
            displayResults();
        }

        const userAgents = ['Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/114.0.0.0 Safari/537.36','Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/114.0.0.0 Safari/537.36','Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:109.0) Gecko/20100101 Firefox/115.0'];

        function parseRSS(xmlText) {
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(xmlText, 'text/xml');
            const items = [];
            xmlDoc.querySelectorAll('item').forEach(item => {
                const title = item.querySelector('title')?.textContent || '';
                const link = item.querySelector('link')?.textContent || '';
                if (title && link) items.push({ title: title.trim(), url: link.trim() });
            });
            return items;
        }

        function parseHTML(htmlText, baseUrl) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(htmlText, 'text/html');
            const items = [];
            const addedUrls = new Set();
            doc.querySelectorAll('a').forEach(linkElement => {
                const href = linkElement.getAttribute('href');
                if (!href || href.trim() === '#' || href.startsWith('javascript:')) return;
                let title = (linkElement.querySelector('h1, h2, h3, h4, [class*="title"], [class*="headline"]')?.textContent || linkElement.textContent).trim().replace(/\s{2,}/g, ' ');
                if (title && href) {
                    try {
                        const absoluteUrl = new URL(href, baseUrl).href;
                        if (!addedUrls.has(absoluteUrl)) {
                            items.push({ title, url: absoluteUrl });
                            addedUrls.add(absoluteUrl);
                        }
                    } catch (e) {}
                }
            });
            return items;
        }
        
        function parseOwlting(htmlText) {
            const items = [];
            try {
                const regex = /\{id:(\d+),fetch_url:".*?",title:"(.*?)",description:"(.*?)"/g;
                let match;
                while ((match = regex.exec(htmlText)) !== null) {
                    const id = match[1];
                    let title = match[2].replace(/\\u002F/g, '/');
                    const description = match[3].replace(/\\u002F/g, '/');
                    if (!title && description) {
                        const sentenceEnd = description.search(/[。？！]/);
                        title = sentenceEnd !== -1 ? description.substring(0, sentenceEnd + 1).trim() : description.substring(0, 50).trim() + '...';
                    }
                    if (id && title) {
                        items.push({
                            title: title,
                            url: `https://news.owlting.com/articles/${id}`,
                            content: description.toLowerCase()
                        });
                    }
                }
            } catch (e) { console.error('奧丁丁專用解析器失敗:', e); }
            return items;
        }

        function parseLifeNews(htmlText, baseUrl) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(htmlText, 'text/html');
            const items = [];
            doc.querySelectorAll('.card-parent').forEach(card => {
                const title = card.querySelector('.card-title.list-title')?.textContent.trim();
                const href = card.querySelector('a.stretched-link')?.getAttribute('href');
                if (title && href) {
                    try { items.push({ title, url: new URL(href, baseUrl).href }); } catch (e) {}
                }
            });
            return items;
        }

        async function searchWebsite(website, keyword) {
            const isDebugMode = document.getElementById('debugModeCheckbox').checked;
            try {
                const response = await fetch(website.url, {
                    method: 'GET',
                    headers: { 'User-Agent': userAgents[Math.floor(Math.random() * userAgents.length)], 'Accept': 'text/html,application/xhtml+xml,*/*;q=0.9' },
                    timeout: 15000, redirect: 'follow'
                });
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const text = await response.text();
                if (isDebugMode) {
                    rawHtmlCache[website.name] = text;
                }
                let items = [];
                if (website.name.includes('奧丁丁')) items = parseOwlting(text);
                else if (website.name.includes('Life生活網')) items = parseLifeNews(text, website.url);
                else if ((response.headers.get('content-type') || '').includes('xml')) items = parseRSS(text);
                else items = parseHTML(text, website.url);
                const searchKeyword = keyword.toLowerCase();
                const matches = items.filter(item => item.title.toLowerCase().includes(searchKeyword) || (item.content && item.content.includes(searchKeyword)));
                if (matches.length > 0) {
                    const filtered = matches.filter(match => !website.name.includes('PChome') || match.title.toLowerCase().trim() !== searchKeyword);
                    if (filtered.length > 0) {
                        return filtered.map(match => ({
                            id: searchResultIdCounter++,
                            website: website.name,
                            title: match.title,
                            url: match.url,
                            status: 'success'
                        }));
                    }
                }
                return [{ id: searchResultIdCounter++, website: website.name, title: '未找到相符的新聞', url: '', status: 'no_match' }];
            } catch (error) {
                console.error(`[偵錯] ${website.name} - 發生錯誤:`, error);
                let msg = `連線錯誤: ${error.message}`;
                if (error.message.includes('403')) msg = '網站拒絕存取 (403 Forbidden)';
                else if (error.cause?.code === 'ERR_HTTP2_PROTOCOL_ERROR') msg = 'HTTP/2 通訊協定錯誤';
                else if (error.name === 'TimeoutError' || error.name === 'AbortError') msg = '連線超時';
                if (isDebugMode) {
                    rawHtmlCache[website.name] = `抓取失敗！\n\n錯誤: ${error.message}\n${error.stack || ''}`;
                }
                return [{ id: searchResultIdCounter++, website: website.name, title: '搜尋失敗', url: '', error: msg, status: 'error' }];
            }
        }

        function displayResults() {
            const isDebugMode = document.getElementById('debugModeCheckbox').checked;
            const resultsContainer = document.getElementById('resultsContainer');
            if (searchResults.length === 0) {
                 document.getElementById('resultsSection').classList.add('hidden');
                 return;
            }
            const groupedResults = {};
            searchResults.forEach(result => {
                if (!groupedResults[result.website]) groupedResults[result.website] = [];
                groupedResults[result.website].push(result);
            });

            const orderedWebsiteNames = [];
            for (const result of searchResults) {
                if (!orderedWebsiteNames.includes(result.website)) {
                    orderedWebsiteNames.push(result.website);
                }
            }

            const successCount = searchResults.filter(r => r.status === 'success').length;
            document.getElementById('resultCount').textContent = `(找到 ${successCount} 筆，搜尋了 ${orderedWebsiteNames.length} 個網站)`;
            
            let html = '';
            orderedWebsiteNames.forEach(website => {
                const results = groupedResults[website];
                const hasSuccess = results.some(r => r.status === 'success');
                let viewSourceButtonHtml = '';
                if (isDebugMode) {
                    viewSourceButtonHtml = `<button class="btn btn-secondary btn-small" onclick="showRawHtml('${String(website).replace(/'/g, "\\'")}');">檢視原始碼</button>`;
                }

                let deleteButtonHtml = '';
                if (!hasSuccess) {
                    deleteButtonHtml = `<button class="btn-delete" title="刪除此區塊" onclick="deleteWebsiteResult('${String(website).replace(/'/g, "\\'")}')">×</button>`;
                }

                html += `<div class="result-item"><div class="result-website-header"><div class="result-website" style="font-weight: 600; color: var(--accent-color); margin-bottom: 8px;">${website} ${hasSuccess?'<span style="color:var(--success-color);font-size:12px;">✓ 成功</span>':''} ${results.some(r=>r.status === 'error')?'<span style="color:var(--error-color);font-size:12px;">✗ 失敗</span>':''} ${results.every(r=>r.status === 'no_match')?'<span style="color:var(--text-muted);font-size:12px;">✓ 無相符結果</span>':''}</div><div class="actions">${viewSourceButtonHtml}${deleteButtonHtml}</div></div>`;
                
                results.forEach(result => {
                    if (result.status === 'success') {
                        html += `
                        <div class="result-link-item">
                            <button class="btn-delete" title="刪除此連結" onclick="deleteResult(${result.id})">×</button>
                            <div style="font-weight: 500; margin-bottom: 8px;">${result.title}</div>
                            <div style="color: var(--text-secondary); font-size: 13px; word-break: break-all; margin-bottom: 8px;">${result.url}</div>
                            <div style="display: flex; gap: 8px;">
                                <button class="btn btn-secondary btn-small" onclick="copyToClipboard('${result.url.replace(/'/g, "\\'")}')">複製</button>
                                <button class="btn btn-secondary btn-small" onclick="window.open('${result.url}', '_blank')">開啟</button>
                            </div>
                        </div>`;
                    } else if (result.status === 'error') {
                        html += `<div style="color:var(--error-color);font-size:13px;margin:8px 0;padding:8px;background:rgba(239,68,68,0.1);border-radius:4px;"><div style="font-weight:500;">搜尋失敗</div><div>${result.error}</div></div>`;
                    }
                });
                if (results.every(r=>r.status === 'no_match')) {
                    html += `<div style="color:var(--text-muted);font-size:13px;margin:8px 0;padding:8px;background:var(--bg-tertiary);border-radius:4px;">未在該網站上找到符合關鍵字的新聞</div>`;
                }
                html += `</div>`;
            });
            resultsContainer.innerHTML = html;
            document.getElementById('resultsSection').classList.remove('hidden');
        }
        
        function showConfirmation(title, message) {
            return new Promise((resolve) => {
                const modal = document.getElementById('confirmModal');
                document.getElementById('confirmTitle').textContent = title;
                document.getElementById('confirmMessage').textContent = message;

                const okBtn = document.getElementById('confirmOkBtn');
                const cancelBtn = document.getElementById('confirmCancelBtn');

                const cleanup = () => {
                    okBtn.removeEventListener('click', onOk);
                    cancelBtn.removeEventListener('click', onCancel);
                };

                const onOk = () => {
                    cleanup();
                    modal.classList.add('hidden');
                    resolve(true);
                };

                const onCancel = () => {
                    cleanup();
                    modal.classList.add('hidden');
                    resolve(false);
                };

                okBtn.addEventListener('click', onOk, { once: true });
                cancelBtn.addEventListener('click', onCancel, { once: true });

                modal.classList.remove('hidden');
            });
        }

        function showRawHtml(websiteName) {
            document.getElementById('modalTitle').textContent = `抓取到的 ${websiteName} 原始碼`;
            document.getElementById('modalContent').value = rawHtmlCache[websiteName] || '沒有快取到此網站的原始碼。請確認搜尋時已啟用除錯模式。';
            document.getElementById('htmlModal').classList.remove('hidden');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showStatus('連結已複製到剪貼簿', 'success');
            }).catch(err => { showStatus('複製失敗', 'error'); });
        }

        function copyAllResults() {
            const grouped = searchResults.filter(r => r.status === 'success').reduce((acc, r) => {
                if (!acc[r.website]) acc[r.website] = [];
                acc[r.website].push(r.url);
                return acc;
            }, {});
            if (Object.keys(grouped).length === 0) { showStatus('沒有可複製的連結', 'error'); return; }
            let output = '';
            const orderedWebsiteNames = [];
            for (const result of searchResults) {
                if (result.status === 'success' && !orderedWebsiteNames.includes(result.website)) {
                    orderedWebsiteNames.push(result.website);
                }
            }
            orderedWebsiteNames.forEach(website => {
                output += `${website}\n${grouped[website].join('\n')}\n\n`;
            });
            copyToClipboard(output.trim());
        }

        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey || e.metaKey) {
                if (e.key === 'Enter' && !isSearching) { e.preventDefault(); startSearch(); }
                if (e.key === 'd') { e.preventDefault(); toggleTheme(); }
                if (e.key === 'l') { e.preventDefault(); loadAllLists(); }
            }
        });
    </script>
</body>
</html>